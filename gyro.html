<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Motion Mouse - Final</title>
    <style>
        body {
            background-color: #222;
            color: white;
            font-family: sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        header {
            padding: 15px;
            background: #333;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug { font-size: 0.8rem; font-family: monospace; color: #aaa; }

        /* The Trackpad */
        #trackpad {
            flex: 1;
            position: relative;
            background: radial-gradient(circle, #333 1px, transparent 1px);
            background-size: 30px 30px;
            background-color: #1a1a1a;
            overflow: hidden;
            border-bottom: 1px solid #444;
        }

        /* The Cursor */
        #cursor {
            width: 40px;
            height: 40px;
            background: #00e5ff;
            border-radius: 50%;
            position: absolute;
            top: 0; 
            left: 0;
            /* We use translate for high performance movement */
            transform: translate3d(0px, 0px, 0); 
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.6);
            pointer-events: none;
            will-change: transform;
        }

        /* Controls */
        #controls {
            padding: 20px;
            background: #222;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding-bottom: 40px; /* Safe area for mobile */
        }

        button {
            padding: 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        #btnStart { background: #4CAF50; color: white; }
        #btnCal { background: #2196F3; color: white; }
        
        button:disabled { background: #555; color: #888; }

        .status-msg {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <header>
        <div>Mobile Mouse</div>
        <div id="debugInfo" class="debug">Waiting...</div>
    </header>

    <div id="trackpad">
        <div id="cursor"></div>
    </div>

    <div id="controls">
        <div class="status-msg" id="statusText">Hold phone comfortably -> Press Calibrate</div>
        <button id="btnStart">1. Start Sensors</button>
        <button id="btnCal" disabled>2. Calibrate (Set Zero)</button>
    </div>

    <script>
        // --- Elements ---
        const cursor = document.getElementById('cursor');
        const btnStart = document.getElementById('btnStart');
        const btnCal = document.getElementById('btnCal');
        const debugInfo = document.getElementById('debugInfo');
        const statusText = document.getElementById('statusText');
        const trackpad = document.getElementById('trackpad');

        // --- State ---
        let isRunning = false;
        let pos = { x: 0, y: 0 }; // Cursor position in pixels
        let center = { beta: 0, gamma: 0 }; // The "Zero" angles
        let calibrated = false;
        
        // Config
        const sensitivity = 3.0; // Increase to move faster

        // --- Initialize Position ---
        // Center the cursor in the middle of the trackpad on load
        function centerCursor() {
            const rect = trackpad.getBoundingClientRect();
            pos.x = rect.width / 2 - 20; // 20 is half cursor width
            pos.y = rect.height / 2 - 20;
            updateCursorVisual();
        }
        
        window.addEventListener('resize', centerCursor);
        // Call once after a short delay to ensure layout is done
        setTimeout(centerCursor, 100);

        function updateCursorVisual() {
            // Using translate3d is much smoother than changing top/left
            cursor.style.transform = `translate3d(${pos.x}px, ${pos.y}px, 0)`;
        }

        // --- Sensor Logic ---

        function handleOrientation(event) {
            if (!isRunning || !calibrated) return;

            let beta = event.beta;   // Front/Back tilt (-180 to 180)
            let gamma = event.gamma; // Left/Right tilt (-90 to 90)

            // Calculate the DIFFERENCE from the center point
            // This allows you to hold the phone at any angle (e.g. 45 deg)
            // and that becomes "Zero movement".
            let deltaBeta = beta - center.beta;
            let deltaGamma = gamma - center.gamma;

            // Update Debug Info
            debugInfo.innerText = `β:${Math.round(beta)} (Δ${Math.round(deltaBeta)}) | γ:${Math.round(gamma)} (Δ${Math.round(deltaGamma)})`;

            // Move the cursor
            // If delta is positive, we move that direction.
            // We multiply by sensitivity to make it usable speed.
            
            pos.x += deltaGamma * sensitivity; 
            pos.y += deltaBeta * sensitivity;

            // Keep cursor inside the box
            const rect = trackpad.getBoundingClientRect();
            const maxX = rect.width - 40; // Subtract cursor size
            const maxY = rect.height - 40;

            if (pos.x < 0) pos.x = 0;
            if (pos.x > maxX) pos.x = maxX;
            if (pos.y < 0) pos.y = 0;
            if (pos.y > maxY) pos.y = maxY;

            updateCursorVisual();
        }

        function handleMotion(event) {
            // Not strictly used for mouse movement here, but kept for completeness
        }

        // --- Controls ---

        function startSensors() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            activateListeners();
                        } else {
                            alert("Permission denied");
                        }
                    })
                    .catch(console.error);
            } else {
                activateListeners();
            }
        }

        function activateListeners() {
            window.addEventListener("deviceorientation", handleOrientation, true);
            window.addEventListener("devicemotion", handleMotion, true);
            
            isRunning = true;
            btnStart.disabled = true;
            btnStart.textContent = "Active";
            btnCal.disabled = false;
            statusText.textContent = "Sensors ON. Hold steady and press Calibrate.";
        }

        function calibrate() {
            // We need the current orientation values to set as "Zero".
            // We grab them from the last event, but since we don't store the event globally
            // we will just ask the user to press it. 
            // HOWEVER, the event object isn't available in the click handler.
            // So we just set a flag, and the *next* sensor update will capture the "center".
            
            // BETTER APPROACH: Read a recent value?
            // Since sensors fire ~60hz, we can just assume the *current* values in the handler
            // are the ones we want to lock.
            
            // Let's cheat slightly: We'll capture the values inside the orientation handler
            // but only when a specific flag is set.
            
            statusText.textContent = "Calibrating... Keep holding still.";
            
            // We set a timeout to read the values in 100ms
            setTimeout(() => {
                // Since we can't access the event object here, we rely on the loop
                // to treat the *current* position as center immediately.
                // We will do this by simply resetting the 'center' variables 
                // to whatever the latest incoming beta/gamma were.
                // But wait, we don't have access to them here.
                
                // Fix: Let's rely on the event loop to capture the "First Calibrated State".
                // We will toggle a flag.
                justCalibrated = true; 
            }, 50);
        }

        let justCalibrated = false;

        // Redefine handler slightly to support the one-shot calibration
        window.removeEventListener("deviceorientation", handleOrientation); // Clear old
        
        window.addEventListener("deviceorientation", (event) => {
            // Update text always
            debugInfo.innerText = `B:${Math.round(event.beta)} G:${Math.round(event.gamma)}`;

            if (!isRunning) return;

            if (justCalibrated) {
                center.beta = event.beta || 0;
                center.gamma = event.gamma || 0;
                calibrated = true;
                justCalibrated = false;
                statusText.textContent = "Calibrated! Tilt to move.";
                statusText.style.color = "#0f0";
            }

            if (calibrated) {
                let beta = event.beta || 0;
                let gamma = event.gamma || 0;
                
                // Calculate Delta
                let deltaBeta = beta - center.beta;
                let deltaGamma = gamma - center.gamma;

                // Deadzone (ignore tiny wobbles)
                if (Math.abs(deltaBeta) < 2) deltaBeta = 0;
                if (Math.abs(deltaGamma) < 2) deltaGamma = 0;

                pos.x += deltaGamma * sensitivity;
                pos.y += deltaBeta * sensitivity;

                const rect = trackpad.getBoundingClientRect();
                const maxX = rect.width - 40;
                const maxY = rect.height - 40;

                if (pos.x < 0) pos.x = 0;
                if (pos.x > maxX) pos.x = maxX;
                if (pos.y < 0) pos.y = 0;
                if (pos.y > maxY) pos.y = maxY;

                updateCursorVisual();
            }
        }, true);


        btnStart.addEventListener('click', startSensors);
        btnCal.addEventListener('click', () => {
            justCalibrated = true;
            statusText.textContent = "Calibrating...";
        });

    </script>
</body>
</html>
